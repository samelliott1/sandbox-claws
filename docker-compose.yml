version: '3.8'

services:
  # Web UI for the testing hub
  web:
    image: nginx:alpine
    container_name: sandbox-claws-web
    ports:
      - "${WEB_PORT:-8080}:80"
    volumes:
      - ./index.html:/usr/share/nginx/html/index.html:ro
      - ./css:/usr/share/nginx/html/css:ro
      - ./js:/usr/share/nginx/html/js:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    labels:
      - "com.sandbox-claws.component=web"

  # Egress filtering proxy (SECURITY: prevents data exfiltration)
  egress-filter:
    image: sameersbn/squid:latest
    container_name: sandbox-claws-egress-filter
    volumes:
      - ./security/squid.conf:/etc/squid/squid.conf:ro
      - ./security/allowed-domains.txt:/etc/squid/allowed-domains.txt:ro
      - squid-cache:/var/spool/squid
      - squid-logs:/var/log/squid
    networks:
      - sandbox-claws
    restart: unless-stopped
    profiles:
      - secure
      - filtered
    labels:
      - "com.sandbox-claws.component=security"
      - "com.sandbox-claws.security-control=egress-filter"

  # OpenClaw agent in isolated environment (BASIC profile - full internet)
  openclaw:
    build:
      context: ./docker/openclaw
      dockerfile: Dockerfile
    container_name: sandbox-claws-openclaw
    environment:
      - PYTHONUNBUFFERED=1
      - OPENCLAW_ENV=${OPENCLAW_ENV:-sandbox}
      - OPENCLAW_LOG_LEVEL=${OPENCLAW_LOG_LEVEL:-INFO}
      # Proxy settings (only active with 'filtered' profile)
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=localhost,127.0.0.1
    env_file:
      - .env.openclaw
    volumes:
      - openclaw-data:/app/data
      - openclaw-logs:/app/logs
      - ./openclaw-config:/app/config:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    profiles:
      - basic
    labels:
      - "com.sandbox-claws.component=agent"
      - "com.sandbox-claws.isolation=medium"
      - "com.sandbox-claws.profile=basic"

  # OpenClaw agent with egress filtering (FILTERED profile - allowlist only)
  openclaw-filtered:
    build:
      context: ./docker/openclaw
      dockerfile: Dockerfile
    container_name: sandbox-claws-openclaw-filtered
    environment:
      - PYTHONUNBUFFERED=1
      - OPENCLAW_ENV=${OPENCLAW_ENV:-sandbox}
      - OPENCLAW_LOG_LEVEL=${OPENCLAW_LOG_LEVEL:-INFO}
      # Proxy settings (routes through egress-filter)
      - HTTP_PROXY=http://egress-filter:3128
      - HTTPS_PROXY=http://egress-filter:3128
      - NO_PROXY=localhost,127.0.0.1
    env_file:
      - .env.openclaw
    volumes:
      - openclaw-data:/app/data
      - openclaw-logs:/app/logs
      - ./openclaw-config:/app/config:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      - egress-filter
    profiles:
      - filtered
    labels:
      - "com.sandbox-claws.component=agent"
      - "com.sandbox-claws.isolation=high"
      - "com.sandbox-claws.profile=filtered"

  # OpenClaw in AIR-GAPPED mode (no internet access)
  openclaw-airgapped:
    build:
      context: ./docker/openclaw
      dockerfile: Dockerfile
    container_name: sandbox-claws-openclaw-airgapped
    environment:
      - PYTHONUNBUFFERED=1
      - OPENCLAW_ENV=airgapped
      - OPENCLAW_LOG_LEVEL=${OPENCLAW_LOG_LEVEL:-INFO}
      # Point to mock APIs
      - GMAIL_API_BASE=http://mock-apis:8080/gmail
      - CALENDAR_API_BASE=http://mock-apis:8080/calendar
    env_file:
      - .env.openclaw
    volumes:
      - openclaw-data:/app/data
      - openclaw-logs:/app/logs
      - ./openclaw-config:/app/config:ro
    networks:
      - sandbox-claws-isolated
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    profiles:
      - airgapped
    depends_on:
      - mock-apis
    labels:
      - "com.sandbox-claws.component=agent"
      - "com.sandbox-claws.isolation=maximum"
      - "com.sandbox-claws.mode=airgapped"

  # Mock API server for air-gapped testing
  mock-apis:
    image: mockserver/mockserver:latest
    container_name: sandbox-claws-mock-apis
    environment:
      - MOCKSERVER_INITIALIZATION_JSON_PATH=/config/initializer.json
      - MOCKSERVER_LOG_LEVEL=INFO
    volumes:
      - ./mocks:/config:ro
    networks:
      - sandbox-claws-isolated
    profiles:
      - airgapped
    labels:
      - "com.sandbox-claws.component=mock-api"

  # Data Loss Prevention Scanner
  dlp-scanner:
    build:
      context: ./docker/dlp-scanner
      dockerfile: Dockerfile
    container_name: sandbox-claws-dlp
    environment:
      - SCAN_INTERVAL=5
      - ALERT_ON_PATTERNS=credit_card,ssn,api_key,private_key,aws_key
      - ACTION=${DLP_ACTION:-alert}
    volumes:
      - openclaw-logs:/logs:ro
      - ./security/dlp-patterns.json:/config/patterns.json:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    profiles:
      - secure
      - dlp
    labels:
      - "com.sandbox-claws.component=security"
      - "com.sandbox-claws.security-control=dlp"

  # ===== PHASE 1 SECURITY SERVICES =====
  
  # Skill Marketplace Scanner (NEW)
  skill-scanner:
    build:
      context: ./docker/skill-scanner
      dockerfile: Dockerfile
    container_name: sandbox-claws-skill-scanner
    ports:
      - "${SCANNER_PORT:-5001}:5001"
    environment:
      - SKILLS_DIR=/skills
      - SCANNER_PORT=5001
    volumes:
      - ./skills:/skills:ro
      - ./docker/skill-scanner/scan-results:/app/scan-results
    networks:
      - sandbox-claws
    restart: unless-stopped
    profiles:
      - basic
      - filtered
      - secure
    labels:
      - "com.sandbox-claws.component=security"
      - "com.sandbox-claws.security-control=skill-scanner"
      - "com.sandbox-claws.feature=skill-scanner"

  # Filesystem Monitor (NEW)
  filesystem-monitor:
    build:
      context: ./docker/filesystem-monitor
      dockerfile: Dockerfile
    container_name: sandbox-claws-fsmonitor
    ports:
      - "${FSMONITOR_PORT:-5002}:5002"
    environment:
      - SCAN_INTERVAL=5
      - MONITOR_PORT=5002
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE  # Required for process monitoring
    profiles:
      - basic
      - filtered
      - secure
    labels:
      - "com.sandbox-claws.component=security"
      - "com.sandbox-claws.security-control=filesystem-monitor"
      - "com.sandbox-claws.feature=skill-scanner"
  
  # ===== END PHASE 1 SECURITY SERVICES =====

  # ===== PHASE 2A: COST CONTROLS =====
  
  # Cost Tracker Service (NEW)
  cost-tracker:
    build:
      context: ./docker/cost-tracker
      dockerfile: Dockerfile
    container_name: sandbox-claws-cost-tracker
    ports:
      - "${COST_TRACKER_PORT:-5003}:5003"
    environment:
      - COST_TRACKER_PORT=5003
      - MAX_COST_PER_SESSION_USD=${MAX_COST_PER_SESSION_USD:-10.00}
      - MAX_COST_PER_HOUR_USD=${MAX_COST_PER_HOUR_USD:-50.00}
      - MAX_COST_PER_DAY_USD=${MAX_COST_PER_DAY_USD:-200.00}
      - MAX_API_CALLS_PER_MINUTE=${MAX_API_CALLS_PER_MINUTE:-30}
      - MAX_TOKENS_PER_REQUEST=${MAX_TOKENS_PER_REQUEST:-8000}
      - ALERT_AT_PERCENT=${ALERT_AT_PERCENT:-80.0}
    networks:
      - sandbox-claws
    restart: unless-stopped
    profiles:
      - basic
      - filtered
      - secure
    labels:
      - "com.sandbox-claws.component=security"
      - "com.sandbox-claws.security-control=cost-tracker"
      - "com.sandbox-claws.feature=cost-tracker"
  
  # ===== END PHASE 2A: COST CONTROLS =====

  # Monitoring and logging with Dozzle
  logs:
    image: amir20/dozzle:latest
    container_name: sandbox-claws-logs
    ports:
      - "${LOG_PORT:-8081}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sandbox-claws
    restart: unless-stopped
    environment:
      - DOZZLE_LEVEL=info
      - DOZZLE_FILTER=label=com.sandbox-claws.component
    labels:
      - "com.sandbox-claws.component=monitoring"

  # Network traffic monitoring with ntopng
  network-monitor:
    image: vimagick/ntopng
    container_name: sandbox-claws-network
    ports:
      - "${MONITOR_PORT:-3000}:3000"
    networks:
      - sandbox-claws
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - NTOPNG_HTTP_PORT=3000
    profiles:
      - monitoring
    labels:
      - "com.sandbox-claws.component=network-monitoring"

  # Cloudflare Tunnel for remote access (optional)
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: sandbox-claws-tunnel
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - sandbox-claws
    restart: unless-stopped
    profiles:
      - remote-access
    labels:
      - "com.sandbox-claws.component=remote-access"

networks:
  sandbox-claws:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  
  # Isolated network - NO internet access (for air-gapped mode)
  sandbox-claws-isolated:
    driver: bridge
    internal: true  # No external routing
    ipam:
      config:
        - subnet: 172.29.0.0/16

volumes:
  openclaw-data:
    driver: local
  openclaw-logs:
    driver: local
  squid-cache:
    driver: local
  squid-logs:
    driver: local

# ===== PHASE 1: CREDENTIAL ISOLATION =====
# Secrets are mounted as read-only files (NOT as host volume mounts)
# This prevents OpenClaw from accessing ~/.ssh/, ~/.aws/, etc.
secrets:
  openclaw_api_keys:
    file: ./secrets/api_keys.txt
# ===== END PHASE 1 =====
